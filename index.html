<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Escáner SKU</title>
  <style>
    :root { --bg:#0b0f1a; --card:#111827; --ink:#fff; --accent:#2563eb; --stroke:#374151; }
    * { box-sizing:border-box }
    body { margin:0; background:var(--bg); color:var(--ink); font-family: system-ui, Arial, sans-serif; }
    .wrap { max-width:720px; margin:0 auto; padding:10px; }
    .card { background:var(--card); border-radius:16px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.3); }
    video { width:100%; border-radius:12px; background:#000; }
    .row { display:flex; gap:8px; margin:10px 0; align-items:center; flex-wrap:wrap; }
    .btn { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; background:var(--accent); color:#fff; font-weight:600; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .input { flex:1; min-width:160px; padding:10px; border-radius:10px; border:1px solid var(--stroke); background:#0f172a; color:#fff; }
    .msg  { margin-top:8px; font-size:.95rem; opacity:.85; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <button class="btn" id="startBtn">Iniciar cámara</button>
        <button class="btn" id="flipBtn" disabled>Cambiar</button>
      </div>
      <video id="preview" playsinline muted autoplay></video>
      <div class="row">
        <input id="sku" class="input" placeholder="SKU detectado…" readonly />
        <button class="btn" id="copyBtn">Copiar</button>
      </div>
      <div id="msg" class="msg"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest"></script>
  <script>
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const videoEl  = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const flipBtn  = document.getElementById('flipBtn');
    const copyBtn  = document.getElementById('copyBtn');
    const skuEl    = document.getElementById('sku');
    const msgEl    = document.getElementById('msg');

    let devices = [];
    let currentDeviceId = null;
    let currentStream = null;
    let running = false;

    function log(msg){ msgEl.textContent = msg; }
    function isChromeMobile(){ const ua = navigator.userAgent.toLowerCase(); return /android/.test(ua)&&/chrome\//.test(ua)&&!/edg\//.test(ua); }

    async function stopAll(){
      try{ codeReader.reset(); }catch(e){}
      if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; }
      running=false;
    }

    async function warmUp(){
      const constraints = {
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 }, height: { ideal: 720 },
          focusMode: "continuous", advanced:[{ facingMode:"environment" }]
        }, audio:false
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      currentStream = stream;
      videoEl.srcObject = stream;
      await videoEl.play().catch(()=>{});
    }

    async function listCameras(){
      const inputs = await ZXing.BrowserCodeReader.listVideoInputDevices();
      devices = inputs || [];
      flipBtn.disabled = devices.length < 2;
      if(!devices.length) throw new Error("No hay cámaras disponibles");
      if(!currentDeviceId) currentDeviceId = devices[devices.length-1].deviceId; // preferir trasera
    }

    async function decodeWithDevice(id){
      await codeReader.decodeFromVideoDevice(id, videoEl, (result, err) => {
        if(result){
          const v = (result.getText()||"").trim();
          if(v){ skuEl.value = v; log("Detectado: "+v); }
        }
      });
      running=true;
    }

    async function decodeWithConstraints(){
      await codeReader.decodeFromConstraints(
        { video:{ facingMode:{ideal:"environment"}, width:{ideal:1280}, height:{ideal:720} }, audio:false },
        videoEl,
        (result, err)=>{
          if(result){
            const v = (result.getText()||"").trim();
            if(v){ skuEl.value = v; log("Detectado: "+v); }
          }
        }
      );
      running=true;
    }

    async function start(){
      if(location.protocol !== "https:" && location.hostname !== "localhost"){
        log("Este sitio debe servirse por HTTPS para usar la cámara.");
        return;
      }
      if(!navigator.mediaDevices?.getUserMedia){
        log("El navegador no soporta getUserMedia.");
        return;
      }
      try{
        log("Solicitando permisos de cámara…");
        await warmUp();                 // pide permiso y muestra preview
        await listCameras();

        await stopAll();
        if(isChromeMobile()){
          log("Iniciando cámara (Chrome/Android)...");
          await decodeWithDevice(currentDeviceId); // deviceId suele ser más estable
        }else{
          log("Iniciando cámara…");
          await decodeWithConstraints();          // Safari/otros
        }
        log("Cámara activa. Apunta al código.");
      }catch(e){
        console.error(e);
        log("No se pudo iniciar la cámara. Revisa permisos del sitio en tu navegador.");
      }
    }

    startBtn.addEventListener('click', start);

    flipBtn.addEventListener('click', async ()=>{
      try{
        await listCameras();
        const idx = devices.findIndex(d=>d.deviceId===currentDeviceId);
        currentDeviceId = devices[(idx+1)%devices.length].deviceId;
        await stopAll();
        if(isChromeMobile()) await decodeWithDevice(currentDeviceId);
        else await decodeWithConstraints();
      }catch(e){ console.error(e); log("No se pudo cambiar de cámara."); }
    });

    copyBtn.addEventListener('click', async ()=>{
      if(!skuEl.value) return;
      try{ await navigator.clipboard.writeText(skuEl.value); log("SKU copiado."); }catch(e){ log("No se pudo copiar."); }
    });

    // Intenta auto-arranque; si falla, deja el botón visible
    (async()=>{ try{ await start(); }catch(e){ /* el botón queda para gesto manual */ } })();

    window.addEventListener('pagehide', ()=>{ stopAll(); });
  </script>
</body>
</html>
