<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Escáner SKU</title>
  <!-- Evita 404 de favicon -->
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <style>
    :root { --bg:#0b0f1a; --card:#111827; --ink:#fff; --accent:#2563eb; --stroke:#374151; }
    body { margin:0; background:var(--bg); color:var(--ink); font-family: system-ui, Arial, sans-serif; }
    .wrap { max-width:720px; margin:0 auto; padding:10px; }
    .card { background:var(--card); border-radius:16px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.3); }
    video { width:100%; border-radius:12px; background:#000; width:100%; height:auto; }
    .row { display:flex; gap:8px; margin:10px 0; align-items:center; flex-wrap:wrap; }
    .btn { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; background:var(--accent); color:#fff; font-weight:600; }
    .input { flex:1; min-width:160px; padding:10px; border-radius:10px; border:1px solid var(--stroke); background:#0f172a; color:#fff; }
    .msg { margin-top:8px; font-size:.95rem; opacity:.9; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="desktopTitle" style="display:none;text-align:center;font-size:1.2rem;font-weight:600;margin-bottom:12px;opacity:.92;">Escanea el código de barra del producto.</div>
      <div class="row" id="cameraRow">
        <button class="btn" id="startBtn">Iniciar cámara</button>
      </div>
      <video id="preview" playsinline muted autoplay></video>
      <div class="row">
        <input id="sku" class="input" placeholder="SKU detectado…" readonly />
        <button class="btn" id="clearBtn" type="button">Limpiar Código</button>
      </div>
      <div id="qr" style="display:none;justify-content:center;margin:16px 0;"></div>
      <div id="qrLabel" style="display:none;"></div>
      <div class="row" id="photoRow">
        <button class="btn" id="photoBtn">Asociar fotos</button>
      </div>
      <div id="msg" class="msg"></div>
    </div>
  </div>

  <!-- CARGA CORRECTA: @zxing/browser UMD (global = ZXingBrowser) -->
  <script src="https://unpkg.com/@zxing/browser@0.1.5"></script>

  <!-- Sonido de lector de barra -->
  <audio id="beep" src="scanner-beep.mp3" preload="auto"></audio>

  <!-- QRCode.js para escritorio -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- Tu código, NO type=module, y después de la librería -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (typeof ZXingBrowser === 'undefined') {
        document.getElementById('msg').textContent = 'Error: ZXingBrowser no está disponible. Verifica la conexión a internet o la carga de la librería.';
        return;
      }
  const videoEl  = document.getElementById('preview');
      const startBtn = document.getElementById('startBtn');
      const photoBtn = document.getElementById('photoBtn');
      const skuEl    = document.getElementById('sku');
  const msgEl    = document.getElementById('msg');
  const clearBtn = document.getElementById('clearBtn');
      // Limpiar el input SKU y el QR al pulsar el botón
      clearBtn.addEventListener('click', ()=>{
        skuEl.value = '';
        // Forzar evento input para limpiar QR y label
        const event = new Event('input', { bubbles: true });
        skuEl.dispatchEvent(event);
        skuEl.focus();
      });
      const beep     = document.getElementById('beep');

      // USAR ZXingBrowser (no ZXing)
      const reader = new ZXingBrowser.BrowserMultiFormatReader();

      let devices = [];
      let currentId = null;
      let stream = null;
      let audioUnlocked = false;

      function log(m){ msgEl.textContent = m; }
      async function stop(){
        try{ reader.reset(); }catch{}
        if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
        skuEl.value = "";
        log("");
        startBtn.disabled = false;
      }

      async function warmUp(){
        const s = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" }, width:{ideal:1280}, height:{ideal:720} },
          audio: false
        });
        stream = s; videoEl.srcObject = s; await videoEl.play().catch(()=>{});
      }

      async function list(){
        const inputs = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
        devices = inputs || [];
        if(!devices.length) throw new Error("No hay cámaras disponibles");
        if(!currentId) currentId = devices[devices.length-1].deviceId;
      }

      async function decodeWithDevice(id){
        await reader.decodeFromVideoDevice(id, videoEl, (result, err) => {
          if(result){
            const v = (result.getText()||"").trim();
            if (v && skuEl.value !== v) {
              skuEl.value = v;
              log("Detectado: " + v);
              if (beep) {
                beep.pause();
                beep.currentTime = 0;
                beep.play().catch(() => {});
              }
              // Si es móvil, redirigir al Google Form con el SKU prellenado
              if (!isDesktop) {
                const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLScua9KznddTAn4XUVzRsLc4zmzeDzVg7gkhNLbklKp4yOQYBg/viewform?usp=pp_url&entry.5441271=' + encodeURIComponent(v);
                window.location.href = formUrl;
              } else {
                // En escritorio, abrir el selector de archivo como antes
                uploadViaForm(v, msgEl);
              }
            }
          }
        });
      }

      async function start(){
        if(!(location.protocol === 'https:' || location.hostname === 'localhost')){
          log("Se requiere HTTPS para acceder a la cámara."); return;
        }
        if(!navigator.mediaDevices?.getUserMedia){
          log("Este navegador no soporta cámara."); return;
        }
        try{
          log("Solicitando permiso…");
          startBtn.disabled = true;
          await warmUp();
          await list();
          await stop(); // soltamos el warm-up
          await decodeWithDevice(currentId);
          log("Cámara activa. Apunta al código.");
        }catch(e){
          console.error(e);
          if(e && (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError')){
            log("Permiso de cámara denegado. Actívalo en la configuración del navegador.");
          }else{
            log(e?.message || "No se pudo iniciar la cámara.");
          }
          startBtn.disabled = false;
        }
      }

  // Detectar si es escritorio
      const isDesktop = !/android|iphone|ipad|ipod|mobile|windows phone/i.test(navigator.userAgent);
      if(isDesktop){
        // Mostrar título superior en escritorio
        const desktopTitle = document.getElementById('desktopTitle');
        if(desktopTitle) desktopTitle.style.display = '';
        // Oculta el botón de cámara y el video solo en escritorio
        const cameraRow = document.getElementById('cameraRow');
        if(cameraRow) cameraRow.style.display = 'none';
        if(videoEl) videoEl.style.display = 'none';
  skuEl.removeAttribute('readonly');
  skuEl.placeholder = 'Ingrese o escanee SKU/ASKU…';
  // Autofoco en escritorio
  setTimeout(()=>{ skuEl.focus(); }, 100);
        // Mostrar QR al cambiar input
        const qrDiv = document.getElementById('qr');
        let qr = null;
        function showQR(val){
          qrDiv.innerHTML = '';
          let qrLabel = document.getElementById('qrLabel');
          if(qrLabel){
            qrLabel.textContent = 'Escanea el QR para cargar las fotos.';
            qrLabel.style.textAlign = 'center';
            qrLabel.style.margin = '8px 0 0 0';
            qrLabel.style.opacity = '0.85';
          }
          if(val && val.length>0){
            qrDiv.style.display = 'flex';
            // El QR contendrá la URL del Google Form con el SKU prellenado
            const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLScua9KznddTAn4XUVzRsLc4zmzeDzVg7gkhNLbklKp4yOQYBg/viewform?usp=pp_url&entry.5441271=' + encodeURIComponent(val);
            qr = new QRCode(qrDiv, { text: formUrl, width: 240, height: 240, colorDark: '#222', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.H });
            // Hacer clic en el QR abre el Google Form con el SKU
            qrDiv.style.cursor = 'pointer';
            qrDiv.onclick = ()=>{
              window.open(formUrl, '_blank');
            };
            // Mostrar el label
            if(qrLabel) qrLabel.style.display = '';
          }else{
            qrDiv.style.display = 'none';
            qrDiv.style.cursor = '';
            qrDiv.onclick = null;
            // Ocultar el label si existe
            if(qrLabel) qrLabel.style.display = 'none';
          }
        }
        skuEl.addEventListener('input', e=>{
          showQR(skuEl.value.trim());
        });
        // En escritorio, ocultar el botón y mostrar label
        const photoRow = document.getElementById('photoRow');
        if(photoRow) photoRow.style.display = 'none';
        // Crear label si no existe
        let qrLabel = document.getElementById('qrLabel');
        if(!qrLabel){
          qrLabel = document.createElement('div');
          qrLabel.id = 'qrLabel';
          qrLabel.textContent = 'Escanea el QR para cargar las fotos.';
          qrLabel.style.textAlign = 'center';
          qrLabel.style.margin = '8px 0 0 0';
          qrLabel.style.opacity = '0.85';
          qrDiv.parentNode.insertBefore(qrLabel, qrDiv.nextSibling);
        }else{
          qrLabel.style.display = '';
        }
      }else{
        // En móvil, asegurarse que el video y el botón de cámara estén visibles
        const cameraRow = document.getElementById('cameraRow');
        if(cameraRow) cameraRow.style.display = '';
        if(videoEl) videoEl.style.display = '';
        skuEl.setAttribute('readonly', 'readonly');
        skuEl.placeholder = 'SKU detectado…';
        // Ocultar los botones de limpiar y asociar fotos en móvil
        const photoRow = document.getElementById('photoRow');
        if(photoRow) photoRow.style.display = 'none';
        const clearBtn = document.getElementById('clearBtn');
        if(clearBtn) clearBtn.style.display = 'none';
        // Ocultar el label
        const qrLabel = document.getElementById('qrLabel');
        if(qrLabel) qrLabel.style.display = 'none';
      }

      startBtn.addEventListener('click', async () => {
        // Intentar desbloquear el contexto de audio en el primer clic
        if (!audioUnlocked) {
          try {
            await beep.play();
            beep.pause();
            beep.currentTime = 0;
            audioUnlocked = true;
          } catch {}
        }
        start();
      });
      photoBtn.addEventListener('click', ()=>{
        const sku = skuEl.value.trim();
        if(!sku){
          log('Primero escanea o ingresa un SKU.');
          return;
        }
        // Abre Google Forms con el SKU prellenado
        const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLScua9KznddTAn4XUVzRsLc4zmzeDzVg7gkhNLbklKp4yOQYBg/viewform?usp=pp_url&entry.5441271=' + encodeURIComponent(sku);
        window.open(formUrl, '_blank');
      });

      window.addEventListener('pagehide', stop);
      document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stop(); });
      window.addEventListener('beforeunload', stop);
    });
  </script>
</body>
</html>
