<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Escáner SKU</title>
  <style>
    :root { --bg:#0b0f1a; --card:#111827; --ink:#fff; --accent:#2563eb; --stroke:#374151; }
    * { box-sizing:border-box }
    body { margin:0; background:var(--bg); color:var(--ink); font-family: system-ui, Arial, sans-serif; }
    .wrap { max-width:720px; margin:0 auto; padding:10px; }
    .card { background:var(--card); border-radius:16px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.3); }
    video { width:100%; border-radius:12px; background:#000; }
    .row { display:flex; gap:8px; margin:10px 0; align-items:center; flex-wrap:wrap; }
    .btn { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; background:var(--accent); color:#fff; font-weight:600; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .input { flex:1; min-width:160px; padding:10px; border-radius:10px; border:1px solid var(--stroke); background:#0f172a; color:#fff; }
    .msg { margin-top:8px; font-size:.95rem; opacity:.9; }
    .small { font-size:.85rem; opacity:.8; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <button class="btn" id="startBtn">Iniciar cámara</button>
        <button class="btn" id="flipBtn" disabled>Cambiar cámara</button>
      </div>
      <video id="preview" playsinline muted autoplay></video>
      <div class="row">
        <input id="sku" class="input" placeholder="SKU detectado…" readonly />
        <button class="btn" id="copyBtn">Copiar</button>
      </div>
      <div id="msg" class="msg"></div>
      <div class="small" id="hint"></div>
    </div>
  </div>

  <!-- ZXing (lector de códigos) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest"></script>
  <script>
    // === Configura qué hacer con el código detectado ===
    async function onCode(value) {
      // Aquí ya tienes el SKU (value). Ejemplos:
      // await fetch("/tu-endpoint", {method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ sku:value })});
      console.log("SKU:", value);
    }
    // ================================================

    const codeReader = new ZXing.BrowserMultiFormatReader();
    const videoEl = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const flipBtn  = document.getElementById('flipBtn');
    const skuEl    = document.getElementById('sku');
    const copyBtn  = document.getElementById('copyBtn');
    const msgEl    = document.getElementById('msg');
    const hintEl   = document.getElementById('hint');

    let devices = [];
    let currentDeviceId = null;
    let currentStream = null;
    let running = false;

    function log(msg){ msgEl.textContent = msg; }
    function hint(msg){ hintEl.textContent = msg; }
    function isSecure(){ return location.protocol === "https:" || location.hostname === "localhost"; }
    function isChrome(){ return /chrome|chromium/i.test(navigator.userAgent) && !/edg\//i.test(navigator.userAgent); }
    function isAndroid(){ return /android/i.test(navigator.userAgent); }

    function updateSKU(v){ skuEl.value = v; onCode(v); }
    async function stopAll(){
      try{ codeReader.reset(); }catch{}
      if (currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream = null; }
      running = false;
    }

    async function warmUp() {
      // Pide permiso y deja vista previa para desbloquear enumerateDevices
      const constraints = {
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 }, height: { ideal: 720 },
          advanced: [{ facingMode: "environment" }]
        },
        audio: false
      };
      const s = await navigator.mediaDevices.getUserMedia(constraints);
      currentStream = s;
      videoEl.srcObject = s;
      await videoEl.play().catch(()=>{});
      return s;
    }

    async function listCameras() {
      const inputs = await ZXing.BrowserCodeReader.listVideoInputDevices();
      devices = inputs || [];
      if (!devices.length) throw new Error("No hay cámaras disponibles");
      // preferir trasera (suele ser la última en Android; en desktop no importa)
      if (!currentDeviceId) currentDeviceId = devices[devices.length - 1].deviceId;
      flipBtn.disabled = devices.length < 2;
    }

    async function decodeWithConstraints() {
      await codeReader.decodeFromConstraints(
        {
          video: { facingMode:{ ideal:"environment" }, width:{ ideal:1280 }, height:{ ideal:720 } },
          audio: false
        },
        videoEl,
        (result, err)=>{
          if (result) {
            const v = (result.getText()||"").trim();
            if (v) { updateSKU(v); log("Detectado: " + v); }
          }
        }
      );
      running = true;
    }

    async function decodeWithDeviceId(id) {
      await codeReader.decodeFromVideoDevice(id, videoEl, (result, err)=>{
        if (result) {
          const v = (result.getText()||"").trim();
          if (v) { updateSKU(v); log("Detectado: " + v); }
        }
      });
      running = true;
    }

    function explainError(e){
      // Mensajes claros por error conocido
      switch (e && e.name) {
        case "NotAllowedError":
        case "SecurityError":
          return "Permiso de cámara denegado. En Chrome: candado ▶ Permisos ▶ Cámara ▶ Permitir.";
        case "NotFoundError":
        case "DevicesNotFoundError":
          return "No se encontró ninguna cámara en el dispositivo.";
        case "NotReadableError":
        case "TrackStartError":
          return "Otra app está usando la cámara. Ciérrala e inténtalo de nuevo.";
        case "OverconstrainedError":
        case "ConstraintNotSatisfiedError":
          return "La cámara no soporta la resolución solicitada. Reintentando con ajustes más bajos…";
        default:
          return (e && e.message) ? e.message : "Error desconocido al iniciar la cámara.";
      }
    }

    async function startFlow() {
      if (!isSecure()){ log("Este sitio debe servirse por HTTPS para usar la cámara."); return; }
      if (!navigator.mediaDevices?.getUserMedia){ log("El navegador no soporta getUserMedia."); return; }

      try {
        // Si ya está concedido el permiso, Chrome permite auto-arranque
        const supportsPerm = !!(navigator.permissions && navigator.permissions.query);
        if (supportsPerm) {
          try {
            const st = await navigator.permissions.query({ name: "camera" });
            hint("Permiso cámara: " + st.state);
          } catch {}
        }

        log("Solicitando acceso a la cámara…");
        await warmUp();           // permiso + preview
        await listCameras();

        await stopAll();

        // Chrome moderno (sobre todo Android): deviceId es más estable
        if (isChrome()) {
          try {
            await decodeWithDeviceId(currentDeviceId);
            log("Cámara activa. Apunta al código.");
            return;
          } catch (e) {
            console.warn("deviceId falló:", e);
            log("Reintentando sin deviceId…");
          }
        }

        // Fallback general
        try {
          await decodeWithConstraints();
          log("Cámara activa. Apunta al código.");
        } catch (e) {
          console.warn("constraints falló:", e);
          // último intento con deviceId
          await decodeWithDeviceId(currentDeviceId);
          log("Cámara activa. Apunta al código.");
        }
      } catch(e) {
        console.error(e);
        const msg = explainError(e);
        log(msg);
        if (e && (e.name === "OverconstrainedError" || e.name === "ConstraintNotSatisfiedError")) {
          // reintento con 640x480
          try {
            await stopAll();
            const s = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: false });
            currentStream = s; videoEl.srcObject = s; await videoEl.play().catch(()=>{});
            await listCameras(); await decodeWithDeviceId(currentDeviceId);
            log("Cámara activa (baja resolución).");
          } catch (e2) {
            console.error(e2);
            log(explainError(e2));
          }
        }
      }
    }

    // Botones
    document.getElementById('startBtn').addEventListener('click', startFlow);
    document.getElementById('flipBtn').addEventListener('click', async ()=>{
      try {
        await listCameras();
        const i = devices.findIndex(d => d.deviceId === currentDeviceId);
        currentDeviceId = devices[(i+1) % devices.length].deviceId;
        await stopAll();
        await decodeWithDeviceId(currentDeviceId);
        log("Cámara cambiada. Apunta al código.");
      } catch(e) {
        console.error(e);
        log("No se pudo cambiar de cámara.");
      }
    });
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      if(!skuEl.value) return;
      try { await navigator.clipboard.writeText(skuEl.value); log("SKU copiado."); } catch { log("No se pudo copiar."); }
    });

    // Auto-arranque si ya diste permiso antes (Chrome/desktop suele permitir)
    (async () => {
      try { await startFlow(); } catch {}
    })();

    // Limpieza al cambiar de pestaña o salir
    document.addEventListener('visibilitychange', ()=>{ if (document.hidden) stopAll(); });
    window.addEventListener('pagehide', ()=>{ stopAll(); });
  </script>
</body>
</html>
